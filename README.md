# Unicorn App

A Next.js application where users can create animated 3D unicorns that bounce around the screen. Built with React Three Fiber, Neon (serverless Postgres), and Rapier physics.

## Features

- User authentication with Clerk
- Create 3D unicorns with randomized features (colors, accessories, hair styles)
- Rainbow particle effects overlay
- Physics-based bouncing unicorns
- Persistent unicorn storage
- User profile with statistics

## Tech Stack

- **Framework**: Next.js 16+ (App Router)
- **Database**: Neon (serverless Postgres)
- **ORM**: Drizzle ORM
- **Authentication**: Clerk
- **3D Rendering**: React Three Fiber (@react-three/fiber, @react-three/drei)
- **Physics**: @react-three/rapier
- **Styling**: Tailwind CSS

## Setup

### 1. Install Dependencies

```bash
pnpm install
```

### 2. Set Up Neon Database

1. Create a new project at [neon.tech](https://neon.tech)
2. Get your connection string from the Neon dashboard:
   - **For serverless (recommended for Next.js)**: Use the pooled connection string
   - **For persistent servers**: Use the direct connection string
3. Create a `.env.local` file in the root directory:

```env
# Neon Database Connection (pooled connection recommended for Next.js serverless)
DATABASE_URL=postgresql://[USER]:[PASSWORD]@[ENDPOINT]/[DATABASE]?sslmode=require&pgbouncer=true

# Clerk Authentication (if not already set up)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
CLERK_SECRET_KEY=your_clerk_secret_key
```

**Note**: The connection string should include `sslmode=require` for secure connections. For serverless environments (Next.js API routes, Server Actions), use Neon's pooled connection string (includes `pgbouncer=true`).

### 3. Run Database Migration

1. Generate the initial migration from the schema:

   ```bash
   pnpm db:generate
   ```

2. Apply the migration to your database:
   ```bash
   pnpm db:migrate
   ```

This will create:

- The `unicorns` table with proper schema
- Indexes for performance

**Note**: Authorization checks are implemented at the application level (Data Access Layer) rather than using database-level RLS policies. This follows Next.js 16 best practices by keeping authorization close to the data source.

### 4. Run Development Server

```bash
pnpm dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser.

## Database Management

This project uses [Drizzle ORM](https://orm.drizzle.team/) for type-safe database schema management and migrations.

### Migration Scripts

- `pnpm db:generate` - Generate migration files from schema changes in `src/lib/db/schema.ts`
- `pnpm db:migrate` - Apply pending migrations to the database
- `pnpm db:push` - Push schema changes directly to the database (development only, bypasses migrations)
- `pnpm db:studio` - Open Drizzle Studio for visual database inspection and querying
- `pnpm db:drop` - Drop all tables (development only, use with caution)

### Workflow for Database Changes

1. **Modify the schema** in `src/lib/db/schema.ts`
2. **Generate migration**: Run `pnpm db:generate` to create migration files in `migrations/`
3. **Review the migration**: Check the generated SQL files to ensure they're correct
4. **Apply migration**: Run `pnpm db:migrate` to apply changes to your database

**Tip**: Use Neon's database branching feature to test migrations in isolation before applying to production.

**Example workflow:**

```bash
# 1. Edit src/lib/db/schema.ts to add/modify tables or columns
# 2. Generate migration
pnpm db:generate

# 3. Review the generated migration files in migrations/
# 4. Apply the migration
pnpm db:migrate
```

**For quick development iterations**, you can use `pnpm db:push` to sync schema changes directly without creating migration files. However, always use migrations for production deployments.

### Schema Location

The database schema is defined in `src/lib/db/schema.ts`. Import the schema and database instance from `src/lib/db/index.ts` in your application code.

## Project Structure

- `src/app/` - Next.js app router pages
- `src/components/` - React components (Unicorn, ParticleRainbow, etc.)
- `src/lib/` - Utilities (unicorn services, feature generation)
  - `src/lib/db/` - Database schema and connection (Drizzle ORM with Neon)
- `src/contexts/` - React contexts (AuthContext)
- `migrations/` - Database migration files (generated by Drizzle)

## Deployment

The app is ready to deploy on Vercel:

1. Push your code to GitHub
2. Import the project in Vercel
3. Add your environment variables in Vercel settings:
   - `DATABASE_URL` - Neon database connection string (pooled connection recommended)
   - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - Clerk publishable key
   - `CLERK_SECRET_KEY` - Clerk secret key
4. Deploy!

**Note**: 
- Make sure to run `pnpm db:migrate` on your production database after deployment, or set up a migration step in your CI/CD pipeline.
- For serverless environments (Vercel), use Neon's pooled connection string to handle connection limits efficiently.
- The database connection is configured with `max: 1` connection per serverless function instance to prevent connection exhaustion.

## License

See LICENSE file for details.
